<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI æ··åˆè®¡åˆ’æœ¬</title>
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #2c2c2c;
            margin: 0;
            padding: 0;
            height: 100vh;
            height: 100dvh;
            display: flex;
            justify-content: center;
        }

        #app {
            width: 100%;
            max-width: 600px;
            background-color: #ededed;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* --- é¡¶éƒ¨æ  --- */
        .header {
            padding: 15px;
            background-color: #ededed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dcdcdc;
            font-weight: bold;
            color: #333;
            z-index: 10;
        }
        .settings-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.6;
        }

        /* --- èŠå¤©åˆ—è¡¨ --- */
        #chat-container {
            flex: 1;
            padding: 20px 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        /* --- æ¶ˆæ¯æ°”æ³¡ --- */
        .message-row { display: flex; animation: fadeIn 0.3s ease; }
        .user-row { justify-content: flex-end; }
        .ai-row { justify-content: flex-start; }

        .bubble {
            max-width: 85%;
            padding: 12px 16px;
            font-size: 16px;
            line-height: 1.5;
            border-radius: 12px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }

        /* é¢œè‰²åŒºåˆ† */
        .local-task { background-color: #95ec69; color: #000; } /* çº¯æœ¬åœ° (ç»¿) */
        .ai-ask { background-color: #bbbbff; color: #000; } /* é—®AIçš„é—®é¢˜ (æ·¡ç´«) */
        .ai-reply { background-color: #fff; color: #333; } /* AIå›å¤ (ç™½) */
        
        .done { 
            background-color: #e0e0e0 !important; 
            color: #999 !important; 
            text-decoration: line-through; 
        }

        .loading { font-style: italic; color: #999; background: #fff; }

        /* --- åº•éƒ¨è¾“å…¥åŒº --- */
        .input-area {
            background-color: #f7f7f7;
            border-top: 1px solid #dcdcdc;
            padding: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            display: flex;
            align-items: center;
            gap: 8px; /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
        }

        input {
            flex: 1;
            height: 40px;
            border: none;
            border-radius: 8px;
            padding: 0 12px;
            font-size: 16px;
            background-color: #fff;
        }
        input:focus { outline: none; }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        button {
            height: 40px;
            padding: 0 16px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
        }

        .btn-local { background-color: #07c160; } /* ç»¿è‰²ï¼šæœ¬åœ° */
        .btn-local:active { background-color: #06ad56; }

        .btn-ai { background-color: #6200ee; } /* ç´«è‰²ï¼šAI */
        .btn-ai:active { background-color: #3700b3; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="app">
        <div class="header">
            <span>æˆ‘çš„è®¡åˆ’æœ¬</span>
            <button class="settings-btn" onclick="setApiKey()">ğŸ”‘ Key</button>
        </div>

        <div id="chat-container"></div>

        <div class="input-area">
            <input type="text" id="taskInput" placeholder="è¾“å…¥å†…å®¹..." autocomplete="off">
            <button class="btn-local" onclick="handleLocal()">è®°äº‹</button>
            <button class="btn-ai" onclick="handleAI()">é—®AI</button>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const taskInput = document.getElementById('taskInput');
        
        let tasks = JSON.parse(localStorage.getItem('hybridTasks')) || [];
        let apiKey = localStorage.getItem('geminiApiKey') || '';

        // åˆå§‹åŒ–
        if (tasks.length === 0) {
            appendElement({
                id: 0, text: 'ğŸ‘‹ éšç§ä¿æŠ¤æ¨¡å¼å·²å¼€å¯ã€‚\n- ç‚¹ã€è®°äº‹ã€‘ï¼šä»…ä¿å­˜åœ¨æ‰‹æœºï¼Œç»å¯¹å®‰å…¨ã€‚\n- ç‚¹ã€é—®AIã€‘ï¼šå‘é€ç»™ Gemini è·å–çµæ„Ÿã€‚', type: 'ai-reply'
            });
        } else {
            renderAll();
        }

        function setApiKey() {
            const key = prompt("è¯·è¾“å…¥ Gemini API Key (AIza...):", apiKey);
            if (key) { apiKey = key; localStorage.setItem('geminiApiKey', key); alert("Key å·²æ›´æ–°"); }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ 1ï¼šæœ¬åœ°è®°äº‹ (ç»å¯¹éšç§) ---
        function handleLocal() {
            const text = taskInput.value.trim();
            if (!text) return;

            const msg = {
                id: Date.now(),
                text: text,
                type: 'local-task', // æ ‡è®°ä¸ºæœ¬åœ°ä»»åŠ¡
                done: false
            };
            
            tasks.push(msg);
            saveData();
            appendElement(msg);
            
            taskInput.value = '';
            scrollToBottom();
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ 2ï¼šé—® AI (è”ç½‘) ---
        async function handleAI() {
            const text = taskInput.value.trim();
            if (!text) return;
            if (!apiKey) { alert("è¯·å…ˆç‚¹å‡»å³ä¸Šè§’è®¾ç½® API Key"); return; }

            // 1. å…ˆæŠŠä½ çš„é—®é¢˜æ˜¾ç¤ºå‡ºæ¥ (ç”¨ä¸åŒé¢œè‰²åŒºåˆ†ï¼Œè¡¨ç¤ºè¿™æ¡å‘ç»™äº†AI)
            const askMsg = {
                id: Date.now(),
                text: text,
                type: 'ai-ask', 
                done: false
            };
            tasks.push(askMsg);
            saveData();
            appendElement(askMsg);
            
            taskInput.value = '';
            scrollToBottom();

            // 2. å‘èµ·è¯·æ±‚
            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message-row ai-row';
            loadingDiv.id = loadingId;
            loadingDiv.innerHTML = `<div class="bubble ai-reply loading">AI æ­£åœ¨æ€è€ƒ...</div>`;
            chatContainer.appendChild(loadingDiv);
            scrollToBottom();

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }] // åªå‘é€è¿™ä¸€å¥è¯ï¼Œä¸å‘é€å†å²è®°å½•ï¼Œæ›´å®‰å…¨
                    })
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (data.candidates && data.candidates[0].content) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    const replyMsg = {
                        id: Date.now() + 1,
                        text: aiText,
                        type: 'ai-reply'
                    };
                    tasks.push(replyMsg);
                    saveData();
                    appendElement(replyMsg);
                }
            } catch (error) {
                document.getElementById(loadingId).remove();
                alert("è¿æ¥å¤±è´¥: " + error.message);
            }
        }

        // --- æ¸²æŸ“é€»è¾‘ ---
        function appendElement(msg) {
            const row = document.createElement('div');
            // æœ¬åœ°ä»»åŠ¡å’ŒAIæé—®é å³ï¼ŒAIå›å¤é å·¦
            row.className = `message-row ${msg.type === 'ai-reply' ? 'ai-row' : 'user-row'}`;
            
            const bubble = document.createElement('div');
            let bubbleClass = `bubble ${msg.type}`;
            if (msg.done) bubbleClass += ' done';
            
            bubble.className = bubbleClass;
            // ç®€å•çš„ Markdown å¤„ç† (åŠ ç²—)
            let htmlContent = msg.text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            bubble.innerHTML = htmlContent;

            // ç‚¹å‡»äº‹ä»¶ï¼šåªæœ‰"æœ¬åœ°ä»»åŠ¡"å’Œ"AIå›å¤"å¯ä»¥è¢«æ ‡è®°å®Œæˆ/å˜ç°
            // "AIæé—®"é€šå¸¸ä¸éœ€è¦æ ‡è®°å®Œæˆ
            bubble.onclick = () => {
                msg.done = !msg.done;
                // é‡æ–°è®¡ç®— class
                bubble.className = `bubble ${msg.type} ${msg.done ? 'done' : ''}`;
                saveData();
            };

            // åŒå‡»åˆ é™¤
            bubble.ondblclick = () => {
                if(confirm('åˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ')) {
                    tasks = tasks.filter(t => t.id !== msg.id);
                    saveData();
                    row.remove();
                }
            };

            row.appendChild(bubble);
            chatContainer.appendChild(row);
            scrollToBottom();
        }

        function renderAll() {
            chatContainer.innerHTML = '';
            tasks.forEach(msg => appendElement(msg));
            scrollToBottom();
        }

        function saveData() {
            localStorage.setItem('hybridTasks', JSON.stringify(tasks));
        }

        function scrollToBottom() {
            setTimeout(() => { chatContainer.scrollTop = chatContainer.scrollHeight; }, 50);
        }

        // å›è½¦é»˜è®¤åªè§¦å‘"è®°äº‹" (æ›´å®‰å…¨)ï¼Œæƒ³é—®AIå¿…é¡»ç‚¹æŒ‰é’®
        taskInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLocal();
        });
    </script>
</body>
</html>
